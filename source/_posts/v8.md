---
title: v8
date: 2020-07-30 15:53:12
tags:
    - knowledge fragment
---

###### what

V8 was first designed to increase the performance of JavaScript execution inside web browsers. In order to obtain speed, V8 translates JavaScript code into more efficient machine code instead of using an interpreter. 

It compiles JavaScript code into machine code at execution by implementing a JIT (Just-In-Time) compiler like a lot of modern JavaScript engines do such as SpiderMonkey or Rhino (Mozilla). 

The main difference here is that V8 doesn’t produce bytecode or any intermediate code.



Before version 5.9 of V8 came out (released earlier this year), the engine used two compilers
    -- full-codegen

    -- Crankshaft（JIT）

##### lnlining

Inlining solves the performance and maintainability issue by letting you declare the function as inline (at least in C++),

so that when you call that function - instead of having your app jumping around at runtime - the code in the inline function is injected at compile time every time that given function is called


##### Hidden class


Most JavaScript interpreters use dictionary-like structures (hash function based) to store the location of object property values in the memory. 

This structure makes retrieving the value of a property in JavaScript more computationally expensive than it would be in a non-dynamic

reson: In such cases, it’s much better to initialize dynamic properties in the same order so that the hidden classes can be reused


##### Inline caching

V8 takes advantage of another technique for optimizing dynamically typed languages called inline caching. 

Inline caching relies on the observation that repeated calls to the same method tend to occur on the same type of object


##### How to write optimized JavaScript

Order of object properties: always instantiate your object properties in the same order so that hidden classes, and subsequently optimized code, can be shared.
Dynamic properties: adding properties to an object after instantiation will force a hidden class change and slow down any methods that were optimized for the previous hidden class. Instead, assign all of an object’s properties in its constructor.

Methods: code that executes the same method repeatedly will run faster than code that executes many different methods only once (due to inline caching).

Arrays: avoid sparse arrays where keys are not incremental numbers. Sparse arrays which don’t have every element inside them are a hash table. Elements in such arrays are more expensive to access. Also, try to avoid pre-allocating large arrays. It’s better to grow as you go. Finally, don’t delete elements in arrays. It makes the keys sparse.

Tagged values: V8 represents objects and numbers with 32 bits. It uses a bit to know if it is an object (flag = 1) or an integer (flag = 0) called SMI (SMall Integer) because of its 31 bits. Then, if a numeric value is bigger than 31 bits, V8 will box the number, turning it into a double and creating a new object to put the number inside. Try to use 31 bit signed numbers whenever possible to avoid the expensive boxing operation into a JS object.
